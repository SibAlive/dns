{% extends "header/base.html" %}

{% block content %}
<link type="text/css" href="{{ url_for('catalog.static', filename='css/styles.css') }}" rel="stylesheet" />

<div class="catalog-container">
<!-- breadcrumbds -->
    <nav arial-label="breadcrumb">
        <ol class="breadcrumb">
            {% for item in breadcrumbs %}
                <li class="breadcrumb-item">
                    {% if item.endpoint %}
                        <a href="{{ url_for(item.endpoint, **item.params) }}">{{ item.name }}</a>
                    {% else %}
                        {{ item.name }}
                    {% endif %}
                </li>
            {% endfor %}
        </ol>
    </nav>

    <h1 class="catalog-title">{{ title }}</h1>

    <div class="sort-controls">
        Сортировать по:
        <button class="sort-btn" data-sort-by="price">Цене</button>
        <button class="sort-btn" data-sort-by="name">Имени</button>
    </div>

    <div class="products-grid">
      {% for product in pagination.items %}
        <div class="products-card">
            <a href="{{ url_for(
                    'catalog.product',
                    product_slug=product.slug) }}" class="no-underline">
              <div class="products-header">
                  {% set main_img = product.images | selectattr('is_main') | first %}
                      {% if main_img %}
                        <img src="{{ url_for('catalog.static', filename='images/' ~ main_img.image_path) }}"
                             alt="{{ product.name }}"
                             class="products-main-img"
                             id="mainProductImg">
                      {% else %}
                        <img src="{{ url_for('catalog.static', filename='images/placeholder.jpg') }}"
                             alt="Изображение отсутствует"
                             class="products-main-img"
                             id="mainProductImg">
                      {% endif %}
              </div>
              <div class="products-title">
                {{ product.name }}
              </div>
            </a>
              <div class="products-purchase-row">
                <span class="products-price">{{ '{:,.0f}'.format(product.price).replace(',', ' ') }} ₽</span>
                  {% set is_favorite = product.id in favorite_ids %}
                        <button class="fav-btn favorite-toggle-btn {% if is_favorite %} is-fav {% endif %}"
                                data-product-id="{{ product.id }}">
                            &#10084;
                        </button>
                  <form method="post" action="{{ url_for('catalog.add_to_cart', product_id=product.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ g.csrf_token }}">
                    <button type="submit" class="products-cart"></button>
                  </form>
              </div>
          <div class="products-stores">
              {% if product.stock_quantity %}
                В наличии
              {% else %}
                Нет в наличии
              {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

<!--Навигация-->
    <nav class="pagination">
        {% if pagination.has_prev %}
            <a href="{{ url_for('catalog.products', subcategory_slug=subcategory_slug,
            page=pagination.prev_num) }}"
               class="page-link">← Предыдущая</a>
        {% endif %}

        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                    <a href="{{ url_for('catalog.products', subcategory_slug=subcategory_slug,
                    page=page_num) }}"
                       class="page-link">{{ page_num }}</a>
                {% else %}
                    <span class="page-active">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span class="page-dots">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
            <a href="{{ url_for('catalog.products', subcategory_slug=subcategory_slug,
            page=pagination.next_num) }}"
               class="page-link">Следующая →</a>
        {% endif %}

        <div class="pagination-info">
            Показаны {{ pagination.first }}-{{ pagination.last }} из {{ pagination.total }} товаров
        </div>
    </nav>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Конфигурация из шаблона ---
        const sortUrl = "{{ url_for('catalog.product_sort', subcategory_slug=subcategory_slug) }}";
        const initialFavoriteIds = {{ favorite_ids | tojson }};
        const imagePathTemplate = "{{ url_for('catalog.static', filename='images/').rstrip('/') }}/";
        const csrfToken = "{{ csrf_token() }}";
        const currentPage = {{ pagination.page }};
        const perPage = 8; // или {{ pagination.per_page }} если динамически

        // Обработчик сортировки
        document.querySelectorAll('.sort-btn').forEach(button => {
            button.addEventListener('click', function () {
                const sortBy = this.dataset.sortBy;

                // Переключаем направление
                const currentOrder = window.sortState?.[sortBy] === 'asc' ? 'desc' : 'asc';
                window.sortState = window.sortState || {};
                window.sortState[sortBy] = currentOrder;

                // Обновляем внешний вид кнопок
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.classList.remove('sort-asc', 'sort-desc');
                });
                this.classList.add(`sort-${currentOrder}`);

                // Формируем URL с параметрами
                const urlParams = new URLSearchParams({
                    sort_by: sortBy,
                    order: currentOrder,
                    page: currentPage,
                    per_page: perPage
                });

                const fullUrl = `${sortUrl}?${urlParams.toString()}`;

                console.log("Запрашиваем сортировку:", fullUrl);

                // Выполняем запрос
                fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Получены отсортированные товары:", data);

                    const grid = document.querySelector('.products-grid');
                    if (!grid) {
                        console.error('Контейнер .products-grid не найден');
                        return;
                    }

                    // Очищаем и вставляем новые товары
                    grid.innerHTML = '';

                    data.products.forEach(product => {
                        const productUrl = `/catalog/product/${product.slug}`;
                        const isFavClass = initialFavoriteIds.includes(product.id) ? "is-fav" : "";

                        const card = `
                            <div class="products-card">
                                <a href="${productUrl}" class="no-underline">
                                    <div class="products-header">
                                        <img src="${product.image_url}" alt="${product.name}" class="products-main-img">
                                    </div>
                                    <div class="products-title">${product.name}</div>
                                </a>
                                <div class="products-purchase-row">
                                    <span class="products-price">${product.price.toLocaleString('ru-RU').replace(/\s/g, ' ')} ₽</span>
                                    <button class="fav-btn favorite-toggle-btn ${isFavClass}" data-product-id="${product.id}">&#10084;</button>
                                    <button class="products-cart"></button>
                                </div>
                                <div class="products-stores">${product.stock_quantity > 0 ? 'В наличии' : 'Нет в наличии'}</div>
                            </div>
                        `;
                        grid.insertAdjacentHTML('beforeend', card);
                    });

                    console.log('Сетка товаров обновлена.');
                })
                .catch(error => {
                    console.error('Ошибка при сортировке:', error);
                    alert('Не удалось применить сортировку. Попробуйте позже.');
                });
            });
        });
    });
</script>

{% endblock %}